pool:
  vmImage: "ubuntu-latest"

trigger: none
pr:
  - master

variables:
  buildConfiguration: "Release"

steps:
  - task: UseDotNet@2
    displayName: "Use DotNet (global.json)"
    inputs:
      packageType: "sdk"
      useGlobalJson: true

  - script: dotnet restore
    displayName: "DotNet restore"

  - task: SonarCloudPrepare@1
    displayName: "SonarCloud prepare"
    inputs:
      SonarCloud: "SonarCloud - tbaker"
      organization: "pex"
      projectKey: "pex-sdk-dotnet"
      projectName: "$(build.repository.name)"
      projectVersion: "$(build.buildNumber)"

  - task: DotNetCoreCLI@2
    displayName: "DotNet test $(buildConfiguration)"
    inputs:
      command: test
      arguments: "--no-restore --configuration $(buildConfiguration)"

  - task: SonarCloudAnalyze@1
    displayName: "SonarCloud analyze"

  - task: SonarCloudPublish@1
    displayName: "SonarCloud publish"
    inputs:
      pollingTimeoutSec: "300"

  - task: WhiteSource@20
    displayName: "WhiteSource analyze"
    inputs:
      cwd: "$(build.artifactStagingDirectory)"
      extensions: ".dll"
      checkPolicies: "FAIL_ON_BUILD"
      productName: "$(system.teamProject)"
      projectRule: "projectName"
      projectName: "$(build.repository.name)"
      forceCheckAllDependencies: true
      forceUpdate: true
      WhiteSourceService: "WhiteSource"
