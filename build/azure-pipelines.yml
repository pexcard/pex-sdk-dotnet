pool:
  vmImage: "ubuntu-latest"

trigger: none
pr: none

variables:
  - name: buildConfiguration
    value: "Release"
  - name: version.patch
    value: $[counter(format('{0}.{1}', variables['MajorVersion'], variables['MinorVersion']), 0)]
  - name: versionPrefix
    value: $[format('{0}.{1}.{2}', variables['MajorVersion'], variables['MinorVersion'], variables['version.patch'])]
  - name: versionSuffix
    value: $[variables['VersionTag']]
  - name: sourceRevisionId
    value: $(Build.SourceVersion)
  - name: fileVersion
    value: $[pipeline.startTime]
  - name: releaseName
    ${{ if eq(variables['VersionTag'], 'beta') }}:
      value: beta
    ${{ else }}:
      value: none

steps:
  - task: PowerShell@2
    displayName: "update build number/name"
    inputs:
      targetType: "inline"
      script: |
        if ([string]::IsNullOrWhiteSpace($versionSuffix)) {
          Write-Host "##vso[build.updatebuildnumber]$(versionPrefix)"
        } else {
          Write-Host "##vso[build.updatebuildnumber]$(versionPrefix)-$(versionSuffix)"
        }
      failOnStderr: true
      pwsh: true

  - task: UseDotNet@2
    displayName: "use dotnet (global.json)"
    inputs:
      packageType: "sdk"
      useGlobalJson: true

  - task: DotNetCoreCLI@2
    displayName: "dotnet restore"
    inputs:
      command: "restore"
      feedsToUse: "select"

  - task: DotNetCoreCLI@2
    displayName: "dotnet test"
    inputs:
      command: test
      projects: "tests/**/*.csproj"
      arguments: "--configuration $(buildConfiguration)"

  - task: SonarCloudPrepare@1
    displayName: sonar prepare
    inputs:
      SonarCloud: "SonarCloud - tbaker"
      organization: "pex"
      projectKey: "pex-sdk-dotnet"
      projectName: "$(Build.Repository.Name)"
      projectVersion: "$(Build.BuildNumber)"

  - script: dotnet pack src/PexCard.Api.Client.Core/PexCard.Api.Client.Core.csproj --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) -p:VersionPrefix='$(versionPrefix)' -p:VersionSuffix='$(versionSuffix)' -p:SourceRevisionId='$(sourceRevisionId)' -p:FileVersion='$(fileVersion)'
    displayName: pack PexCard.Api.Client.Core

  - script: dotnet pack src/PexCard.Api.Client/PexCard.Api.Client.csproj --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) -p:VersionPrefix='$(versionPrefix)' -p:VersionSuffix='$(versionSuffix)' -p:SourceRevisionId='$(sourceRevisionId)' -p:FileVersion='$(fileVersion)'
    displayName: pack PexCard.Api.Client

  - task: SonarCloudAnalyze@1
    displayName: sonar analyze

  - task: SonarCloudPublish@1
    displayName: sonar publish
    inputs:
      pollingTimeoutSec: "300"

  - task: WhiteSource@20
    displayName: whitesource scan
    inputs:
      cwd: "$(Build.ArtifactStagingDirectory)"
      extensions: ".dll"
      checkPolicies: "FAIL_ON_BUILD"
      productName: "$(System.TeamProject)"
      projectRule: "projectName"
      projectName: "$(Build.Repository.Name)"
      forceCheckAllDependencies: true
      forceUpdate: true
      WhiteSourceService: "WhiteSource"

  - task: PublishBuildArtifacts@1
    displayName: "publish artifacts"
    inputs:
      PathtoPublish: "$(Build.ArtifactStagingDirectory)"
      ArtifactName: "drop"
      publishLocation: "Container"
